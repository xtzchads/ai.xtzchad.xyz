<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staking Assistant</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            font-family: "GT Eesti Pro Display Regular", sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Ensure body takes at least full viewport height */
        }

        main {
            flex-grow: 1;
            /* Allow main content to grow and take remaining space */
        }

        footer {
            background-color: #343a40;
            color: #fff;
            text-align: center;
            padding: 10px 0;
            width: 100%;

            bottom: 0;
            /* Position the footer at the bottom of the viewport */
        }

        header {
            background-color: #0F61FF;
            color: #fff;
            width: 100%;
            text-align: center;
            padding: 1em 0;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            padding: 20px;
        }

        .card {
            border: none;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background-color: #0F61FF;
            border-color: #0F61FF;
        }

        .btn-primary:hover {
            background-color: #003EE0;
            border-color: #003EE0;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        .table {
            font-size: 0.9rem;
        }

        .form-check-input:checked {
            background-color: #0F61FF;
            border-color: #0F61FF;
        }

        .form-check-input:checked+.form-check-label {
            color: #0F61FF;
        }

        .form-check-label {
            cursor: pointer;
        }

        .badge {
            font-size: 0.8rem;
        }


        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #4CAF50;
            color: #fff;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 999;
        }

        .notification.error {
            background-color: #f44336;
        }

        .notification.show {
            opacity: 1;
        }
    </style>
</head>

<body>

    <header class="bg-primary py-3">
        <div class="container">
            <h1 class="text-white mb-0">Staking Assistant</h1>
        </div>
    </header>

    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="text-center">
                            <h4 class="mb-4">Stake or unstake your tezzies with your <b>current</b> baker.</h4>
                        </div>

                        <div class="row align-items-center mt-4">
                            <div class="col-md-2"></div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <input type="number" class="form-control form-control-md" id="amountInput"
                                    placeholder="Amount">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-md w-100" onclick="stakeTez()">Stake</button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary btn-md w-100" onclick="unstakeTez()">Unstake</button>
                            </div>
                            <div class="col-md-2"></div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <h5 class="card-title mb-3">Available Bakers</h5>
                            </div>
                            <div class="col-auto">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" checked="checked"
                                        id="toggleAllBakers" onchange="applyFilter()">
                                    <label class="form-check-label" for="toggleAllBakers">Low fees</label>

                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" checked="checked"
                                        id="toggleAliasBakers" onchange="applyFilter()">
                                    <label class="form-check-label" for="toggleAliasBakers">Public bakers</label>
                                </div>
                            </div>
                        </div>

                        <table class="table table-striped table-hover" id="delegateTable">
                            <thead>
                                <tr>
                                    <th scope="col">Address</th>
                                    <th scope="col">Alias</th>
                                    <th id="freeSpaceHeader" scope="col" style="cursor: pointer;">Free Space</th>
                                    <th id="feeHeader" scope="col" style="cursor: pointer;">Fee (%)</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div id="wallet" style="display:none" class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="text-center mb-3" id="walletInfo">
                            <!-- Wallet info will be dynamically populated -->
                        </div>
                        <button class="btn btn-outline-danger mt-3 w-100" onclick="disconnectWallet()">Disconnect
                            Wallet</button>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Alternative options to stake</h5>
                        <ul class="list-unstyled mt-3 mb-0">
                            <li><a href="https://gov.tez.capital" target="_blank">gov.tez.capital</a></li>
                            <li><a href="https://stake.tezos.com" target="_blank">stake.tezos.com</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-3 mt-auto">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 Chad Staking Assistant. All chads reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Beacon SDK -->
    <script src="https://unpkg.com/@airgap/beacon-sdk@4.2.2/dist/walletbeacon.min.js"></script>
    <!-- Custom JavaScript -->
    <script>
        let allBakers = [];
        let filteredBakers = [];
        let client = new beacon.DAppClient({name: 'Staking Assistant'});
        let permissions;
		client.subscribeToEvent(beacon.BeaconEvent.ACTIVE_ACCOUNT_SET, (account) => {
  // An active account has been set, update the dApp UI
  checkActiveSession();
});

        async function fetchDelegateData() {
            const freeSpaceHeader = document.getElementById('freeSpaceHeader');
            const feeHeader = document.getElementById('feeHeader');
            //const spinner = document.getElementById('spinner');
            const table = document.getElementById('delegateTable');
            //const totalStakedBalanceDiv = document.getElementById('totalStakedBalance');

            //spinner.style.display = 'block';
            table.style.display = 'none';

            try {
                let bakers = await fetch('https://api.tzkt.io/v1/delegates?limit=10000&active=true');
                let data = await bakers.json();
                //let stats = await fetch('https://api.tzkt.io/v1/statistics/current');
                //let staked = await stats.json();

                allBakers = [];
                data.forEach(delegate => {
                    if (delegate.limitOfStakingOverBaking && delegate.limitOfStakingOverBaking > 0) {
                        let address = delegate.address;
                        let alias = delegate.alias || 'No alias';
                        let balance = ((delegate.stakedBalance * delegate.limitOfStakingOverBaking / 1000000 - delegate.externalStakedBalance) / 1000000).toFixed(6);
                        let edgeOfBakingOverStaking = (delegate.edgeOfBakingOverStaking / 10000000).toFixed(2);

                        allBakers.push({
                            address: address,
                            alias: "<a href='https://tzkt.io/"+address+"' target='_blank'>"+alias+"</a>",
                            balance: parseInt(balance),
                            edgeOfBakingOverStaking: edgeOfBakingOverStaking + "%"
                        });
                    }
                });

                // Display total staked balance
                //totalStakedBalanceDiv.textContent = 'Total Staked Balance: ' + parseInt(staked.totalFrozen / 1000000).toLocaleString() + ' tez (' + (staked.totalFrozen / staked.totalSupply * 100).toFixed(2) + '%)';

                // Sort the data by balance in descending order
                allBakers.sort((a, b) => b.balance - a.balance);

                filteredBakers = allBakers;
                applyFilter();
            } catch (error) {
                console.error('Error fetching delegate data:', error);
            } finally {
                //spinner.style.display = 'none';
                table.style.display = 'table';
            }
            let sortDirection = {
                freeSpace: 'desc',
                fee: 'desc'
            };
            freeSpaceHeader.addEventListener('click', () => {
                if (sortDirection.freeSpace === 'desc') {
                    allBakers.sort((a, b) => a.balance - b.balance);
                    sortDirection.freeSpace = 'asc';
                } else {
                    allBakers.sort((a, b) => b.balance - a.balance);
                    sortDirection.freeSpace = 'desc';
                }
                applyFilter();
            });

            feeHeader.addEventListener('click', () => {
                if (sortDirection.fee === 'desc') {
                    allBakers.sort((a, b) => a.edgeOfBakingOverStaking.slice(0, -1) - b.edgeOfBakingOverStaking.slice(0, -1));
                    sortDirection.fee = 'asc';
                } else {
                    allBakers.sort((a, b) => b.edgeOfBakingOverStaking.slice(0, -1) - a.edgeOfBakingOverStaking.slice(0, -1));
                    sortDirection.fee = 'desc';
                }
                applyFilter();
            });
        }

        function applyFilter() {
            const table = document.getElementById('delegateTable');
            const showAllBakers = document.getElementById('toggleAllBakers').checked;
            const showAliasBakers = document.getElementById('toggleAliasBakers').checked;

            filteredBakers = allBakers;

            if (showAllBakers) {
                filteredBakers = filteredBakers.filter(delegate => parseFloat(delegate.edgeOfBakingOverStaking) <= 40);
            } else {
                filteredBakers = filteredBakers.filter(delegate => parseFloat(delegate.edgeOfBakingOverStaking) > 40);
            }

            if (showAliasBakers) {
                filteredBakers = filteredBakers.filter(delegate => delegate.alias !== 'No alias');
            } else {
                filteredBakers = filteredBakers.filter(delegate => delegate.alias === 'No alias');
            }

            // Clear the table body
            const tableBody = table.querySelector('tbody');
            tableBody.innerHTML = '';

            // Populate the table with filtered data
            filteredBakers.forEach(delegate => {
                let row = tableBody.insertRow();
                let cell1 = row.insertCell(0);
                let cell2 = row.insertCell(1);
                let cell3 = row.insertCell(2);
                let cell4 = row.insertCell(3);
                let cell5 = row.insertCell(4);

                cell1.textContent = delegate.address;
                cell2.textContent = delegate.alias;
                cell3.textContent = delegate.balance;
                cell4.textContent = delegate.edgeOfBakingOverStaking;
                cell5.innerHTML = "<button class=\"btn btn-primary btn-sm w-100\" onclick=\"delegateTez('" + delegate.address + "', this)\">Delegate</button>";
            });
        }

        // Sort table by column index
        function sortTable(columnIndex, isNumeric) {
            const table = document.getElementById('delegateTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);

            const compare = (a, b) => {
                const cellA = a.cells[columnIndex].textContent;
                const cellB = b.cells[columnIndex].textContent;
                return isNumeric ? parseFloat(cellA) - parseFloat(cellB) : cellA.localeCompare(cellB);
            };

            const currentOrder = table.getAttribute('data-sort-order') === 'asc' ? 'desc' : 'asc';
            table.setAttribute('data-sort-order', currentOrder);

            rows.sort((a, b) => currentOrder === 'asc' ? compare(a, b) : compare(b, a));

            rows.forEach(row => tbody.appendChild(row));
        }

        document.getElementById('toggleAllBakers').addEventListener('change', applyFilter);
        document.getElementById('toggleAliasBakers').addEventListener('change', applyFilter);

        async function stakeTez() {
            const amountInput = document.getElementById('amountInput');
            const amount = parseFloat(amountInput.value);

            try {
                if (!permissions?.address) {
                    permissions = await client.requestPermissions();
                    checkActiveSession();
                }
                const operation = [
                    {
                        amount: (amount * 1000000).toString(),
                        kind: beacon.TezosOperationType.TRANSACTION,
                        source: permissions.address,
                        destination: permissions.address,
                        parameters: {
                            entrypoint: "stake",
                            value: {
                                "prim": "Unit"
                            }
                        }
                    }
                ];

                const response = await client.requestOperation({operationDetails: operation});
                showNotification(`Successfully staked ${amount} tez. Transaction hash: ${response.transactionHash}`);
                amountInput.value = '';
            } catch (error) {
                console.error('Error staking tez:', error);
                showNotification('Failed to stake tez. Please try again.', true);
            }
        }

        async function unstakeTez() {
            const amountInput = document.getElementById('amountInput');
            const amount = parseFloat(amountInput.value);

            try {
                if (!permissions?.address) {
                    permissions = await client.requestPermissions();
                    checkActiveSession();
                }
                const operation = [
                    {
                        amount: (amount * 1000000).toString(),
                        kind: beacon.TezosOperationType.TRANSACTION,
                        source: permissions.address,
                        destination: permissions.address,
                        parameters: {
                            entrypoint: "unstake",
                            value: {
                                "prim": "Unit"
                            }
                        }
                    }
                ];

                const response = await client.requestOperation({operationDetails: operation});
                showNotification(`Successfully unstaked ${amount} tez. Transaction hash: ${response.transactionHash}`);
                amountInput.value = '';
            } catch (error) {
                console.error('Error unstaking tez:', error);
                showNotification('Failed to unstake tez. Please try again.', true);
            }
        }

        async function delegateTez(address) {
            try {
                if (!permissions?.address) {
                    permissions = await client.requestPermissions();
                    checkActiveSession();
                }
                const operation = [
                    {
                        kind: beacon.TezosOperationType.DELEGATION,
                        delegate: address,
                    }
                ];

                const response = await client.requestOperation({operationDetails: operation});
                showNotification(`Successfully delegated tez to ${address}. Transaction hash: ${response.transactionHash}`);
            } catch (error) {
                console.error('Error delegating tez:', error);
                showNotification('Failed to delegate tez. Please try again.', true);
            }
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.classList.add('notification', isError ? 'error' : 'success');
            notification.textContent = message;
            document.body.appendChild(notification);
            notification.offsetHeight;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 10000);
        }

        async function checkActiveSession() {
            const walletInfoDiv = document.getElementById('wallet');
            const activeAccount = await client.getActiveAccount();
            if (activeAccount) {
                // Active session found
                permissions = {address: activeAccount.address};
                wallet.style.display = 'flex';
                displayWalletInfo(activeAccount.address);
            }
            else
                wallet.style.display = 'none'; // Hide walletInfo if no active session

        }

        function displayWalletInfo(address) {
            const walletInfoDiv = document.getElementById('walletInfo');
            walletInfoDiv.innerHTML = `<span>${address}</span>`;
        }

        async function disconnectWallet() {
            await client.clearActiveAccount();
            const walletInfoDiv = document.getElementById('walletInfo');
            walletInfoDiv.innerHTML = '';
            permissions = null;
        }

        // Initial fetch and periodic update
        fetchDelegateData();
        setInterval(fetchDelegateData, 60000);

        document.addEventListener('DOMContentLoaded', checkActiveSession);
    </script>

</body>

</html>
